import{r as N,j as e,t as y,a as Y,B as X,u as $,s as C}from"./main-B5FlV0ud.js";import{u as z}from"./useMutation-DsfTo1KK.js";import{A as W,D as ee}from"./AdminGuard-CcPwdLTL.js";import{I as w,B as S}from"./button-BmSOyNex.js";import{D as te,a as se,E as re,b as ae,c as ne,d as R,n as O,S as oe,j as ie,k as ce,l as le,m as de}from"./sheet-BQfrc174.js";import{T as ue,a as he,b as Q,c as b,d as me,e as f}from"./table-BGnGoEK-.js";import{L as m}from"./label-Chk9yu5q.js";import{E as xe}from"./eye-yUEJkRyM.js";import{c as ge}from"./x-DfPbw0Sj.js";import"./search-BWiiaxVB.js";import"./chevron-right-BD-QEjtD.js";const pe=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],ye=ge("eye-off",pe),be={title:"",subtitle:"",description:"",cta_text:"",cta_url:"",background_image_url:"",background_image_path:"",accent_color:"",content_type:"custom",content_id:null,order_weight:0,is_active:!0};function fe({initial:k,onSubmit:g,onCancel:M,submitting:T=!1,books:B,authors:_,posts:j}){const[r,q]=N.useState({...be,...k}),[x,o]=N.useState(k?.background_image_url??null),[p,v]=N.useState(null),A=/^#[0-9a-fA-F]{6}$/.test(r.accent_color)?r.accent_color:"#4b5563",i=(s,d)=>{q(P=>({...P,[s]:d}))},E=async s=>{if(s.preventDefault(),!r.title.trim()){y.error("Title is required");return}try{await g(r,p)}catch(d){console.error("Submit error:",d)}},F=()=>{switch(r.content_type){case"book":return B;case"author":return _;case"post":return j;default:return[]}},D=s=>r.content_type==="author"?s.name:s.title;return N.useEffect(()=>{if(r.content_type==="custom"||!r.content_id)return;let s="";switch(r.content_type){case"book":s=`/livro/${r.content_id}`;break;case"author":s=`/autor/${r.content_id}`;break;case"post":s=`/post/${r.content_id}`;break}s&&r.cta_url!==s&&i("cta_url",s)},[r.content_type,r.content_id]),e.jsxs("form",{className:"space-y-6",onSubmit:E,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Background Image"}),e.jsx("div",{className:"rounded-xl border border-dashed border-gray-300 bg-gray-50 p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("label",{htmlFor:"background-image",className:"inline-flex cursor-pointer items-center gap-2 rounded-full border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-100",children:"Choose file"}),e.jsx("input",{id:"background-image",type:"file",accept:"image/*",onChange:s=>{const d=s.target.files?.[0]??null;if(d&&d.size>5242880){y.error("Background image must be 5MB or less."),s.currentTarget.value="";return}v(d),d&&o(URL.createObjectURL(d))},className:"hidden"}),e.jsxs("div",{className:"flex flex-col text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:p?.name??x?"Preview loaded":"No file chosen"}),e.jsx("span",{className:"text-xs text-gray-500",children:"JPG/PNG, up to 5MB"})]}),x&&e.jsx("img",{src:x,alt:"Background preview",className:"h-20 w-32 rounded-md border border-gray-200 object-cover ml-auto"})]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Upload a landscape image optimized for hero display (recommended: 1920x1080)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"title",children:"Title *"}),e.jsx(w,{id:"title",required:!0,value:r.title,onChange:s=>i("title",s.target.value),placeholder:"Enter slide title"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"subtitle",children:"Subtitle"}),e.jsx(w,{id:"subtitle",value:r.subtitle,onChange:s=>i("subtitle",s.target.value),placeholder:"Enter subtitle (optional)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",value:r.description,onChange:s=>i("description",s.target.value),className:"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",rows:3,placeholder:"Brief description of the slide"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"cta_text",children:"Call-to-Action Text"}),e.jsx(w,{id:"cta_text",value:r.cta_text,onChange:s=>i("cta_text",s.target.value),placeholder:"e.g., Explorar, Ver Mais, Saber Mais"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"cta_url",children:"Call-to-Action URL"}),e.jsx(w,{id:"cta_url",value:r.cta_url,onChange:s=>i("cta_url",s.target.value),placeholder:"/livros, /autores, https://...",disabled:r.content_type!=="custom"&&!!r.content_id}),r.content_type!=="custom"&&r.content_id?e.jsxs("p",{className:"text-xs text-blue-600",children:["Auto-populated from selected ",r.content_type,'. Change content type to "Custom" to edit manually.']}):e.jsx("p",{className:"text-xs text-gray-500",children:"Enter a relative path (/livros) or absolute URL (https://example.com)"})]}),r.content_type==="author"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"accent_color",children:"Accent Color"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{id:"accent_color",type:"color",value:A,onChange:s=>i("accent_color",s.target.value),className:"h-10 w-14 cursor-pointer rounded border border-gray-300 bg-white p-1"}),e.jsx(w,{type:"text",value:r.accent_color,onChange:s=>i("accent_color",s.target.value),placeholder:"#4b5563"})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Used as the background for Author Highlight slides."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"content_type",children:"Content Type"}),e.jsxs("select",{id:"content_type",value:r.content_type,onChange:s=>{const d=s.target.value;i("content_type",d),i("content_id",null),d!=="author"&&i("accent_color","")},className:"w-full rounded-full border border-gray-300 bg-white px-4 py-2 text-sm text-gray-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2",children:[e.jsx("option",{value:"custom",children:"Custom (standalone slide)"}),e.jsx("option",{value:"book",children:"Book Highlight"}),e.jsx("option",{value:"author",children:"Author Highlight"}),e.jsx("option",{value:"post",children:"Post Highlight"})]}),e.jsx("p",{className:"text-xs text-gray-500",children:'Select what this slide should highlight. Choose "Custom" for standalone slides.'})]}),r.content_type!=="custom"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{htmlFor:"content_id",children:["Select ",r.content_type==="book"?"Book":r.content_type==="author"?"Author":"Post"]}),e.jsxs("select",{id:"content_id",value:r.content_id??"",onChange:s=>i("content_id",s.target.value||null),className:"w-full rounded-full border border-gray-300 bg-white px-4 py-2 text-sm text-gray-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2",children:[e.jsxs("option",{value:"",children:["-- Select ",r.content_type," --"]}),F().map(s=>e.jsx("option",{value:s.id,children:D(s)},s.id))]}),F().length===0&&e.jsxs("p",{className:"text-xs text-amber-600",children:["No ",r.content_type,'s available. Create one first or select "Custom" type.']}),r.content_type==="author"&&e.jsx("p",{className:"text-xs text-gray-500",children:"Only featured authors appear here. Mark authors as featured in the Authors admin."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"order_weight",children:"Order Weight"}),e.jsx(w,{id:"order_weight",type:"number",value:r.order_weight,onChange:s=>i("order_weight",parseInt(s.target.value,10)||0),placeholder:"0"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Lower numbers appear first in the carousel"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"is_active",children:"Status"}),e.jsx("div",{className:"flex items-center gap-4 pt-2",children:e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:r.is_active,onChange:s=>i("is_active",s.target.checked),className:"h-4 w-4 rounded border-gray-300"}),e.jsx("span",{className:"text-gray-900",children:"Active (visible on homepage)"})]})})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t border-gray-200",children:[e.jsx(S,{type:"button",variant:"ghost",onClick:M,children:"Cancel"}),e.jsx(S,{type:"submit",disabled:T,children:T?"Savingâ€¦":"Save Slide"})]})]})}function Ee(){const{profile:k,session:g,signOut:M}=Y(),T=k?.name??g?.user.email??"Admin",B=g?.user.email??"",_="https://kakesgsqdjhrbcdhicey.supabase.co",j="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtha2VzZ3NxZGpocmJjZGhpY2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjkyODYsImV4cCI6MjA4MzA0NTI4Nn0.nuQZcCOQnfNZ7S3VLSrn0cmDz7-hkRYX-RNsI3a_1iw",I=X(),r=async(t,a,n)=>{let l=null;const c=new Promise((u,h)=>{l=setTimeout(()=>{h(new Error(`${n} timed out. Check network or Supabase policies.`))},a)});try{return await Promise.race([t,c])}finally{l&&clearTimeout(l)}},[q,x]=N.useState(!1),[o,p]=N.useState(null),v=$({queryKey:["admin","hero-slides"],queryFn:async()=>{const{data:t,error:a}=await r(C.from("hero_slides").select("*").order("order_weight",{ascending:!0}),15e3,"Hero slides query");if(a)throw a;return t},staleTime:3e4}),A=$({queryKey:["admin","books-for-hero"],queryFn:async()=>{const{data:t,error:a}=await C.from("books").select("id, title, cover_url").order("title",{ascending:!0});if(a)throw a;return t},staleTime:6e4}),i=$({queryKey:["admin","authors-for-hero"],queryFn:async()=>{const{data:t,error:a}=await C.from("authors").select("id, name, photo_url").eq("featured",!0).order("name",{ascending:!0});if(a)throw a;return t},staleTime:6e4}),E=$({queryKey:["admin","posts-for-hero"],queryFn:async()=>{const{data:t,error:a}=await C.from("posts").select("id, title, featured_image_url").eq("status","published").order("title",{ascending:!0});if(a)throw a;return t},staleTime:6e4}),F=async(t,a)=>{if(t.size>5242880)throw new Error("Background image must be 5MB or less.");const l=g?.access_token;if(!l)throw new Error("Missing auth session. Please sign in again.");const c=`hero-backgrounds/${a}/${Date.now()}-${t.name}`,u=c.split("/").map(encodeURIComponent).join("/"),h=new AbortController,L=setTimeout(()=>h.abort(),6e4);try{const U=await fetch(`${_}/storage/v1/object/hero-backgrounds/${u}`,{method:"POST",headers:{apikey:j,Authorization:`Bearer ${l}`,"Content-Type":t.type||"application/octet-stream","x-upsert":"true"},body:t,signal:h.signal});if(!U.ok){const G=await U.text();throw new Error(G||`Image upload failed (${U.status}).`)}}finally{clearTimeout(L)}const{data:Z}=C.storage.from("hero-backgrounds").getPublicUrl(c);return{path:c,publicUrl:Z.publicUrl}},D=async t=>{const a=g?.access_token;if(!a)throw new Error("Missing auth session. Please sign in again.");const n=new AbortController,l=setTimeout(()=>n.abort(),15e3);try{const c=await fetch(`${_}/rest/v1/hero_slides`,{method:"POST",headers:{apikey:j,Authorization:`Bearer ${a}`,"Content-Type":"application/json",Prefer:"return=minimal"},body:JSON.stringify([t]),signal:n.signal});if(!c.ok){const u=await c.text();throw new Error(u||`Slide insert failed (${c.status}).`)}}finally{clearTimeout(l)}},s=async(t,a)=>{const n=g?.access_token;if(!n)throw new Error("Missing auth session. Please sign in again.");const l=`id=eq.${t}`,c=new AbortController,u=setTimeout(()=>c.abort(),15e3);try{const h=await fetch(`${_}/rest/v1/hero_slides?${l}`,{method:"PATCH",headers:{apikey:j,Authorization:`Bearer ${n}`,"Content-Type":"application/json",Prefer:"return=minimal"},body:JSON.stringify(a),signal:c.signal});if(!h.ok){const L=await h.text();throw new Error(L||`Slide update failed (${h.status}).`)}}finally{clearTimeout(u)}},d=async t=>{const a=g?.access_token;if(!a)throw new Error("Missing auth session. Please sign in again.");const n=`id=eq.${t}`,l=new AbortController,c=setTimeout(()=>l.abort(),15e3);try{const u=await fetch(`${_}/rest/v1/hero_slides?${n}`,{method:"DELETE",headers:{apikey:j,Authorization:`Bearer ${a}`,Prefer:"return=minimal"},signal:l.signal});if(!u.ok){const h=await u.text();throw new Error(h||`Slide delete failed (${u.status}).`)}}finally{clearTimeout(c)}},P=z({mutationFn:async t=>{const a=t.id??crypto.randomUUID();let n=t.id??null,l=t.background_image_url,c=t.background_image_path;if(t.file){const h=await F(t.file,a);l=h.publicUrl,c=h.path}const u={title:t.title,subtitle:t.subtitle||null,description:t.description||null,cta_text:t.cta_text||null,cta_url:t.cta_url||null,background_image_url:l,background_image_path:c,accent_color:t.accent_color||null,content_type:t.content_type,content_id:t.content_id,order_weight:t.order_weight,is_active:t.is_active};return t.id?(await s(t.id,u),n=t.id):(u.id=a,await D(u),n=a),n},onSuccess:()=>{I.invalidateQueries({queryKey:["admin","hero-slides"]}),x(!1),p(null),y.success("Hero slide saved")},onError:t=>{y.error(t?.message??"Failed to save hero slide")}}),V=z({mutationFn:async t=>{await d(t)},onSuccess:()=>{I.invalidateQueries({queryKey:["admin","hero-slides"]}),y.success("Hero slide deleted")},onError:t=>y.error(t.message??"Failed to delete hero slide")}),H=z({mutationFn:async t=>{await s(t.id,{is_active:t.is_active})},onSuccess:()=>{I.invalidateQueries({queryKey:["admin","hero-slides"]}),y.success("Status updated")},onError:t=>y.error(t.message??"Failed to update status")}),J=t=>{switch(t){case"book":return"Book";case"author":return"Author";case"post":return"Post";case"custom":return"Custom";default:return t}},K=t=>t.content_type==="custom"||!t.content_id?"-":t.content_type==="book"?A.data?.find(n=>n.id===t.content_id)?.title??"Unknown":t.content_type==="author"?i.data?.find(n=>n.id===t.content_id)?.name??"Unknown":t.content_type==="post"?E.data?.find(n=>n.id===t.content_id)?.title??"Unknown":"-";return e.jsx(W,{children:e.jsx(ee,{userRole:k?.role??"admin",userName:T,userEmail:B,onSignOut:M,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm uppercase text-gray-500",children:"Content"}),e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:"Hero Slides"})]}),e.jsx(S,{onClick:()=>{p(null),x(!0)},children:"New Slide"})]}),e.jsx("div",{className:"rounded-2xl border border-gray-200 bg-white overflow-hidden",children:v.isLoading?e.jsx("p",{className:"text-sm text-gray-500 p-4",children:"Loading hero slides..."}):v.isError?e.jsx("p",{className:"text-sm text-rose-600 p-4",children:"Failed to load hero slides. Check connection or permissions."}):(v.data?.length??0)===0?e.jsxs("div",{className:"p-8 text-center space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"No hero slides yet"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Create your first hero slide to showcase content on the homepage."}),e.jsx(S,{onClick:()=>{p(null),x(!0)},children:"Create First Slide"})]}):e.jsxs(ue,{children:[e.jsx(he,{children:e.jsxs(Q,{children:[e.jsx(b,{className:"w-20",children:"Thumbnail"}),e.jsx(b,{children:"Title"}),e.jsx(b,{children:"Content Type"}),e.jsx(b,{children:"Linked Content"}),e.jsx(b,{className:"w-24",children:"Order"}),e.jsx(b,{className:"w-20",children:"Active"}),e.jsx(b,{className:"w-16",children:"Actions"})]})}),e.jsx(me,{children:v.data?.map(t=>e.jsxs(Q,{className:"hover:bg-gray-50",children:[e.jsx(f,{children:t.background_image_url?e.jsx("img",{src:t.background_image_url,alt:t.title,className:"h-12 w-20 object-cover rounded border border-gray-200"}):e.jsx("div",{className:"h-12 w-20 bg-gray-100 rounded border border-gray-200 flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-gray-400",children:"No image"})})}),e.jsx(f,{className:"font-medium text-gray-900",children:t.title}),e.jsx(f,{className:"text-gray-600",children:J(t.content_type)}),e.jsx(f,{className:"text-gray-600",children:K(t)}),e.jsx(f,{className:"text-gray-600",children:t.order_weight}),e.jsx(f,{children:e.jsx("button",{type:"button",onClick:()=>H.mutate({id:t.id,is_active:!t.is_active}),className:"flex items-center gap-1 text-sm",children:t.is_active?e.jsx(xe,{className:"h-4 w-4 text-green-600"}):e.jsx(ye,{className:"h-4 w-4 text-gray-400"})})}),e.jsx(f,{children:e.jsxs(te,{children:[e.jsx(se,{asChild:!0,children:e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(re,{className:"h-4 w-4"})})}),e.jsxs(ae,{align:"end",children:[e.jsx(ne,{children:"Actions"}),e.jsx(R,{}),e.jsx(O,{onClick:()=>{p(t),x(!0)},children:"Edit"}),e.jsx(O,{onClick:()=>H.mutate({id:t.id,is_active:!t.is_active}),children:t.is_active?"Deactivate":"Activate"}),e.jsx(R,{}),e.jsx(O,{className:"text-destructive focus:text-destructive",onClick:()=>{window.confirm("Are you sure you want to delete this slide?")&&V.mutate(t.id)},children:"Delete"})]})]})})]},t.id))})]})}),e.jsx(oe,{open:q,onOpenChange:x,children:e.jsxs(ie,{className:"w-full sm:max-w-2xl px-4 overflow-hidden",children:[e.jsxs(ce,{children:[e.jsx(le,{children:o?"Edit Hero Slide":"New Hero Slide"}),e.jsx(de,{children:"Create and manage hero slides for the homepage carousel."})]}),e.jsx("div",{className:"pt-4 max-h-[85vh] overflow-y-auto pr-2",children:e.jsx(fe,{initial:o?{title:o.title,subtitle:o.subtitle??"",description:o.description??"",cta_text:o.cta_text??"",cta_url:o.cta_url??"",background_image_url:o.background_image_url??"",background_image_path:o.background_image_path??"",accent_color:o.accent_color??"",content_type:o.content_type,content_id:o.content_id,order_weight:o.order_weight,is_active:o.is_active}:void 0,submitting:P.isPending,onSubmit:async(t,a)=>{await P.mutateAsync({...t,id:o?.id,file:a})},books:A.data??[],authors:i.data??[],posts:E.data??[],onCancel:()=>{x(!1),p(null)}})})]})})]})})})}export{Ee as component};
