import{d as E,a as S,e as q,r as o,j as e,L as P,f as x,t as p,s as h,i as z,h as M}from"./main-B5FlV0ud.js";import{H as O}from"./Header-DLdij8DV.js";import"./x-DfPbw0Sj.js";function I(){const v=E(),{session:m,profile:i}=S(),{items:l,total:u,clearCart:w}=q(),[d,b]=o.useState(!1),[s,n]=o.useState({name:"",email:"",phone:""}),[r,k]=o.useState({});o.useEffect(()=>{n(t=>({name:t.name||i?.name||"",email:t.email||i?.email||m?.user?.email||"",phone:t.phone||i?.phone||""}))},[i,m]);const f=l.length===0,g=o.useMemo(()=>l.map(t=>({book_id:t.id,quantity:t.quantity,price:t.price})),[l]),_=()=>{const t={};return s.name.trim()||(t.name="Nome obrigatorio"),(!s.email.trim()||!z(s.email))&&(t.email="Email invalido"),(!s.phone.trim()||!M(s.phone))&&(t.phone="Telefone invalido"),k(t),Object.keys(t).length===0},C=async t=>{if(t.preventDefault(),!d){if(f){p.error("O carrinho esta vazio");return}if(_())try{b(!0);const{data:a,error:y}=await h.from("orders").insert({customer_id:m?.user?.id??null,customer_name:s.name.trim(),customer_email:s.email.trim().toLowerCase(),customer_phone:s.phone.trim(),total:u,status:"pending"}).select().single();if(y)throw y;const{error:j}=await h.from("order_items").insert(g.map(c=>({...c,order_id:a.id})));if(j)throw j;for(const c of g){const{error:N}=await h.rpc("decrement_book_stock",{book_id:c.book_id,quantity:c.quantity});if(N)throw N}w(),p.success("Pedido criado com sucesso"),v({to:`/pedido/${a.id}`})}catch(a){console.error("Checkout error:",a),p.error("Falha ao criar o pedido. Tente novamente.")}finally{b(!1)}}};return e.jsxs("div",{className:"min-h-screen bg-[#f8f4ef] text-gray-900",children:[e.jsx(O,{}),e.jsxs("main",{className:"container mx-auto px-4 py-16 lg:px-15",children:[e.jsx("h1",{className:"text-3xl font-semibold md:text-5xl",children:"Checkout"}),f?e.jsxs("div",{className:"mt-8 border border-gray-200 bg-white p-8 text-center",children:[e.jsx("p",{className:"text-lg font-semibold text-gray-900",children:"O seu carrinho esta vazio"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Adicione livros antes de finalizar a compra."}),e.jsx(P,{to:"/loja",className:"mt-6 inline-flex items-center justify-center bg-[color:var(--brand)] px-6 py-2.5 text-sm font-semibold uppercase tracking-wider text-white hover:bg-[#a25a2c]",children:"Ir para a loja"})]}):e.jsxs("div",{className:"mt-8 grid gap-8 lg:grid-cols-[1fr_360px]",children:[e.jsxs("form",{onSubmit:C,className:"space-y-6 border border-gray-200 bg-white p-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Dados do cliente"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600",children:"Preencha os dados para concluir o pedido."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Nome completo",e.jsx("input",{type:"text",value:s.name,onChange:t=>n(a=>({...a,name:t.target.value})),className:"mt-2 w-full border border-gray-300 bg-white px-3 py-2 text-sm focus:border-[color:var(--brand)] focus:outline-none"}),r.name&&e.jsx("span",{className:"mt-1 block text-xs text-red-600",children:r.name})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Email",e.jsx("input",{type:"email",value:s.email,onChange:t=>n(a=>({...a,email:t.target.value})),className:"mt-2 w-full border border-gray-300 bg-white px-3 py-2 text-sm focus:border-[color:var(--brand)] focus:outline-none"}),r.email&&e.jsx("span",{className:"mt-1 block text-xs text-red-600",children:r.email})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Telefone",e.jsx("input",{type:"tel",value:s.phone,onChange:t=>n(a=>({...a,phone:t.target.value})),className:"mt-2 w-full border border-gray-300 bg-white px-3 py-2 text-sm focus:border-[color:var(--brand)] focus:outline-none"}),r.phone&&e.jsx("span",{className:"mt-1 block text-xs text-red-600",children:r.phone})]})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[e.jsx("h3",{className:"text-sm font-semibold uppercase tracking-wider text-gray-500",children:"Metodo de pagamento"}),e.jsx("div",{className:"mt-3 space-y-2 text-sm text-gray-700",children:e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",checked:!0,readOnly:!0}),e.jsx("span",{children:"M-Pesa"})]})})]}),e.jsx("button",{type:"submit",disabled:d,className:"w-full bg-[color:var(--brand)] px-6 py-3 text-sm font-semibold uppercase tracking-wider text-white transition-colors hover:bg-[#a25a2c] disabled:cursor-not-allowed disabled:bg-gray-300",children:d?"Processando...":"Confirmar pedido"})]}),e.jsxs("aside",{className:"h-fit border border-gray-200 bg-white p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Resumo do pedido"}),e.jsx("div",{className:"mt-4 space-y-4",children:l.map(t=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-16 w-12 flex-shrink-0 bg-gray-100",children:t.cover_url?e.jsx("img",{src:t.cover_url,alt:t.title,className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-gray-300",children:t.title.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:t.title}),e.jsxs("p",{className:"text-xs text-gray-600",children:[t.quantity," x ",x(t.price)]})]}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:x(t.price*t.quantity)})]},t.id))}),e.jsx("div",{className:"mt-6 border-t border-gray-200 pt-4",children:e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:x(u)})]})})]})]})]})]})}export{I as component};
