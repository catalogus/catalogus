import{r as F,j as e,a as se,B as ae,u as re,t as C,s as j}from"./main-B5FlV0ud.js";import{u as G}from"./useMutation-DsfTo1KK.js";import{A as te,D as le}from"./AdminGuard-CcPwdLTL.js";import{I as u,B as v}from"./button-BmSOyNex.js";import{D as oe,a as ie,E as ne,b as ce,c as de,n as M,d as K,S as he,j as ue,k as pe,l as me,m as xe}from"./sheet-BQfrc174.js";import{D as z,a as Y,b as J,c as H,d as X}from"./dialog-F38b7SJK.js";import{L as d}from"./label-Chk9yu5q.js";import{C as ge}from"./calendar-lCNNRgkW.js";import{M as Z}from"./map-pin-DQhXgVI1.js";import{G as ye,L as je,F as be,I as ve,T as fe,Y as _e}from"./youtube-CxqPD9E6.js";import{c as Ne}from"./x-DfPbw0Sj.js";import"./search-BWiiaxVB.js";import"./chevron-right-BD-QEjtD.js";const we=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],ke=Ne("video",we),T={name:"",phone:"",bio:"",photo_url:"",photo_path:"",social_links:{},birth_date:"",residence_city:"",province:"",published_works:[],author_gallery:[],featured_video:"",author_type:""};function Ce({initial:t,onSubmit:N,onCancel:E,submitting:i=!1,mode:f}){const[o,y]=F.useState({...T,...t,social_links:t?.social_links??T.social_links,published_works:t?.published_works??T.published_works,author_gallery:t?.author_gallery??T.author_gallery}),[_,c]=F.useState(t?.photo_url??null),[P,R]=F.useState(null),x=(r,l)=>{y(s=>({...s,[r]:l}))},b=(r,l)=>{y(s=>({...s,social_links:{...s.social_links,[r]:l||void 0}}))},S=r=>{const l=r.target.files?.[0]??null;R(l),l&&c(URL.createObjectURL(l))},w=()=>{y(r=>({...r,published_works:[...r.published_works,{title:"",genre:"",synopsis:"",link:""}]}))},D=(r,l,s)=>{y(a=>({...a,published_works:a.published_works.map((n,p)=>p===r?{...n,[l]:s}:n)}))},U=r=>{y(l=>({...l,published_works:l.published_works.filter((s,a)=>a!==r)}))},q=async(r,l)=>{const s=l.target.files?.[0];if(!s)return;const a=URL.createObjectURL(s);y(n=>({...n,published_works:n.published_works.map((p,h)=>h===r?{...p,cover_url:a}:p)}))},O=()=>{y(r=>({...r,author_gallery:[...r.author_gallery,{url:"",path:"",caption:""}]}))},A=(r,l,s)=>{y(a=>({...a,author_gallery:a.author_gallery.map((n,p)=>p===r?{...n,[l]:s}:n)}))},$=r=>{y(l=>({...l,author_gallery:l.author_gallery.filter((s,a)=>a!==r)}))},B=r=>{r.preventDefault(),N(o,P)};return e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{htmlFor:"name",children:["Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(u,{id:"name",type:"text",value:o.name,onChange:r=>x("name",r.target.value),required:!0,minLength:2,maxLength:100,placeholder:"Author name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{htmlFor:"author_type",children:["Tipo de Autor ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{id:"author_type",value:o.author_type,onChange:r=>x("author_type",r.target.value),required:!0,className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none focus:ring-1 focus:ring-gray-900",children:[e.jsx("option",{value:"",children:"Selecionar tipo"}),e.jsx("option",{value:"Autor",children:"Autor"}),e.jsx("option",{value:"Cineasta",children:"Cineasta"}),e.jsx("option",{value:"Escritor",children:"Escritor"}),e.jsx("option",{value:"Escritora",children:"Escritora"}),e.jsx("option",{value:"Jornalista",children:"Jornalista"}),e.jsx("option",{value:"Pesquisador",children:"Pesquisador"}),e.jsx("option",{value:"Poeta",children:"Poeta"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"phone",children:"Phone"}),e.jsx(u,{id:"phone",type:"tel",value:o.phone,onChange:r=>x("phone",r.target.value),placeholder:"+258 84 123 4567"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"bio",children:"Bio"}),e.jsx("textarea",{id:"bio",value:o.bio,onChange:r=>x("bio",r.target.value),maxLength:500,rows:4,placeholder:"Author biography (max 500 characters)",className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none focus:ring-1 focus:ring-gray-900"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[o.bio.length,"/500 characters"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"photo",children:"Profile Photo"}),_&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:_,alt:"Preview",className:"h-32 w-32 rounded-lg object-cover border border-gray-200"})}),e.jsx(u,{id:"photo",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",onChange:S}),e.jsx("p",{className:"text-xs text-gray-500",children:"Max 5MB. Supported formats: JPG, PNG, WEBP, GIF"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"birth_date",children:"Birth Date"}),e.jsx(u,{id:"birth_date",type:"date",value:o.birth_date,onChange:r=>x("birth_date",r.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"residence_city",children:"Residence City"}),e.jsx(u,{id:"residence_city",type:"text",value:o.residence_city,onChange:r=>x("residence_city",r.target.value),placeholder:"City name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"province",children:"Province"}),e.jsx(u,{id:"province",type:"text",value:o.province,onChange:r=>x("province",r.target.value),placeholder:"Province name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"featured_video",children:"Featured Video URL"}),e.jsx(u,{id:"featured_video",type:"url",value:o.featured_video,onChange:r=>x("featured_video",r.target.value),placeholder:"https://youtube.com/watch?v=..."}),e.jsx("p",{className:"text-xs text-gray-500",children:"YouTube or Vimeo video URL"})]}),e.jsxs("div",{className:"space-y-3 border-t pt-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Social Links"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"website",children:"Website"}),e.jsx(u,{id:"website",type:"url",value:o.social_links.website??"",onChange:r=>b("website",r.target.value),placeholder:"https://example.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"linkedin",children:"LinkedIn"}),e.jsx(u,{id:"linkedin",type:"url",value:o.social_links.linkedin??"",onChange:r=>b("linkedin",r.target.value),placeholder:"https://linkedin.com/in/username"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"facebook",children:"Facebook"}),e.jsx(u,{id:"facebook",type:"url",value:o.social_links.facebook??"",onChange:r=>b("facebook",r.target.value),placeholder:"https://facebook.com/username"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"instagram",children:"Instagram"}),e.jsx(u,{id:"instagram",type:"url",value:o.social_links.instagram??"",onChange:r=>b("instagram",r.target.value),placeholder:"https://instagram.com/username"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"twitter",children:"Twitter"}),e.jsx(u,{id:"twitter",type:"url",value:o.social_links.twitter??"",onChange:r=>b("twitter",r.target.value),placeholder:"https://twitter.com/username"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"youtube",children:"YouTube"}),e.jsx(u,{id:"youtube",type:"url",value:o.social_links.youtube??"",onChange:r=>b("youtube",r.target.value),placeholder:"https://youtube.com/@username"})]})]}),e.jsxs("div",{className:"space-y-3 border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Obras Publicadas (Published Works)"}),e.jsx(v,{type:"button",onClick:w,className:"bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1",children:"+ Add Work"})]}),o.published_works.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No published works added yet"}):e.jsx("div",{className:"space-y-4",children:o.published_works.map((r,l)=>e.jsxs("div",{className:"border border-gray-300 rounded-lg p-4 space-y-3 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900",children:["Obra #",l+1]}),e.jsx(v,{type:"button",onClick:()=>U(l),className:"bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-xs",children:"Remove"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{htmlFor:`work_cover_${l}`,children:["Capa da Obra ",e.jsx("span",{className:"text-red-500",children:"*"})]}),r.cover_url&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:r.cover_url,alt:"Cover preview",className:"h-32 w-24 object-cover rounded border border-gray-200"})}),e.jsx(u,{id:`work_cover_${l}`,type:"file",accept:"image/jpeg,image/png,image/webp",onChange:s=>q(l,s)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{htmlFor:`work_title_${l}`,children:["Título da Obra ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(u,{id:`work_title_${l}`,type:"text",value:r.title,onChange:s=>D(l,"title",s.target.value),placeholder:"Título que conta na Capa da Obra",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{htmlFor:`work_genre_${l}`,children:["Gênero literário ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{id:`work_genre_${l}`,value:r.genre,onChange:s=>D(l,"genre",s.target.value),required:!0,className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none focus:ring-1 focus:ring-gray-900",children:[e.jsx("option",{value:"",children:"Selecionar o tipo de Obra"}),e.jsx("option",{value:"Romance",children:"Romance"}),e.jsx("option",{value:"Conto",children:"Conto"}),e.jsx("option",{value:"Poesia",children:"Poesia"}),e.jsx("option",{value:"Drama",children:"Drama"}),e.jsx("option",{value:"Infantil",children:"Infantil"}),e.jsx("option",{value:"Ficção Científica",children:"Ficção Científica"}),e.jsx("option",{value:"Suspense",children:"Suspense"}),e.jsx("option",{value:"Outros",children:"Outros"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{htmlFor:`work_synopsis_${l}`,children:["Sinopse da Obra ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{id:`work_synopsis_${l}`,value:r.synopsis,onChange:s=>D(l,"synopsis",s.target.value),placeholder:"Breve descrição/resumo",required:!0,rows:3,className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none focus:ring-1 focus:ring-gray-900"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:`work_link_${l}`,children:"Link da Obra"}),e.jsx(u,{id:`work_link_${l}`,type:"url",value:r.link??"",onChange:s=>D(l,"link",s.target.value),placeholder:"Endereço na web"})]})]},l))})]}),e.jsxs("div",{className:"space-y-3 border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Galeria do Autor (Author Gallery)"}),e.jsx(v,{type:"button",onClick:O,className:"bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1",children:"+ Add Image"})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Add image URLs for the author's gallery"}),o.author_gallery.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No gallery images added yet"}):e.jsx("div",{className:"space-y-3",children:o.author_gallery.map((r,l)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{type:"url",value:r.url,onChange:s=>A(l,"url",s.target.value),placeholder:"Image URL",className:"flex-1"}),e.jsx(v,{type:"button",onClick:()=>$(l),className:"bg-red-600 hover:bg-red-700 text-white px-3",children:"Remove"})]}),e.jsx(u,{type:"text",value:r.caption??"",onChange:s=>A(l,"caption",s.target.value),placeholder:"Caption (optional)"}),r.url&&e.jsx("img",{src:r.url,alt:r.caption||"Gallery preview",className:"h-24 w-full object-cover rounded border border-gray-200",onError:s=>{s.currentTarget.style.display="none"}})]},l))})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 border-t pt-4",children:[e.jsx(v,{type:"button",onClick:E,disabled:i,className:"bg-gray-200 text-gray-900 hover:bg-gray-300",children:"Cancel"}),e.jsx(v,{type:"submit",disabled:i,children:i?f==="create"?"Creating...":"Saving...":f==="create"?"Create Author":"Save Changes"})]})]})}function Ae({author:t}){const N=i=>i?new Date(i).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"N/A",E=t.social_links&&Object.values(t.social_links).some(i=>i);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start gap-6",children:[t.photo_url?e.jsx("img",{src:t.photo_url,alt:t.name,className:"h-32 w-32 rounded-lg object-cover border border-gray-200"}):e.jsx("div",{className:"h-32 w-32 rounded-lg bg-gray-200 flex items-center justify-center border border-gray-300",children:e.jsx("span",{className:"text-4xl text-gray-400",children:t.name.charAt(0).toUpperCase()})}),e.jsx("div",{className:"flex-1 space-y-3",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:t.name}),t.author_type&&e.jsx("p",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:t.author_type})]})})]}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Contact Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Phone"}),e.jsx("p",{className:"text-sm text-gray-900",children:t.phone||"Not provided"})]}),t.wp_slug&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"WordPress Slug"}),e.jsx("p",{className:"text-sm text-gray-900",children:t.wp_slug})]})]})]}),(t.birth_date||t.residence_city||t.province)&&e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.birth_date&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-4 w-4 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Birth Date"}),e.jsx("p",{className:"text-sm text-gray-900",children:N(t.birth_date)})]})]}),t.residence_city&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"City"}),e.jsx("p",{className:"text-sm text-gray-900",children:t.residence_city})]})]}),t.province&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Province"}),e.jsx("p",{className:"text-sm text-gray-900",children:t.province})]})]})]})]}),t.bio&&e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Biography"}),e.jsx("p",{className:"text-sm text-gray-700 whitespace-pre-wrap",children:t.bio})]}),E&&e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Social Links"}),e.jsxs("div",{className:"space-y-2",children:[t.social_links?.website&&e.jsxs("a",{href:t.social_links.website,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 text-sm text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx("span",{children:t.social_links.website})]}),t.social_links?.linkedin&&e.jsxs("a",{href:t.social_links.linkedin,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 text-sm text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx("span",{children:t.social_links.linkedin})]}),t.social_links?.facebook&&e.jsxs("a",{href:t.social_links.facebook,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 text-sm text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(be,{className:"h-4 w-4"}),e.jsx("span",{children:t.social_links.facebook})]}),t.social_links?.instagram&&e.jsxs("a",{href:t.social_links.instagram,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 text-sm text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx("span",{children:t.social_links.instagram})]}),t.social_links?.twitter&&e.jsxs("a",{href:t.social_links.twitter,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 text-sm text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{children:t.social_links.twitter})]}),t.social_links?.youtube&&e.jsxs("a",{href:t.social_links.youtube,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 text-sm text-blue-600 hover:text-blue-700 hover:underline",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx("span",{children:t.social_links.youtube})]})]})]}),t.featured_video&&e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(ke,{className:"h-4 w-4"}),"Featured Video"]}),e.jsx("a",{href:t.featured_video,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:text-blue-700 hover:underline break-all",children:t.featured_video})]}),t.published_works&&t.published_works.length>0&&e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Obras Publicadas (Published Works)"}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:t.published_works.map((i,f)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 flex gap-3",children:[i.cover_url&&e.jsx("img",{src:i.cover_url,alt:i.title,className:"h-32 w-24 object-cover rounded border border-gray-200 shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900",children:i.title}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Gênero:"})," ",i.genre]}),e.jsx("p",{className:"text-sm text-gray-700",children:i.synopsis}),i.link&&e.jsx("a",{href:i.link,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:text-blue-700 hover:underline inline-block",children:"Ver obra"})]})]},f))})]}),t.author_gallery&&t.author_gallery.length>0&&e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Galeria do Autor (Author Gallery)"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:t.author_gallery.map((i,f)=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("img",{src:i.url,alt:i.caption||`Gallery image ${f+1}`,className:"w-full h-32 object-cover rounded border border-gray-200"}),i.caption&&e.jsx("p",{className:"text-xs text-gray-600",children:i.caption})]},f))})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-xs text-gray-500",children:[e.jsxs("div",{children:[e.jsx("p",{children:"Created"}),e.jsx("p",{className:"text-gray-900",children:N(t.created_at)})]}),e.jsxs("div",{children:[e.jsx("p",{children:"Last Updated"}),e.jsx("p",{className:"text-gray-900",children:N(t.updated_at)})]})]})})]})}function Te(){const{profile:t,session:N,signOut:E}=se(),i=t?.name??N?.user.email??"Admin",f=N?.user.email??"",o=ae(),[y,_]=F.useState(!1),[c,P]=F.useState(null),[R,x]=F.useState(null),[b,S]=F.useState(null),w=re({queryKey:["admin","authors"],queryFn:async()=>{try{const{data:s,error:a}=await j.from("authors").select("id, name, wp_id, wp_slug, bio, photo_url, photo_path, phone, social_links, featured, birth_date, residence_city, province, published_works, author_gallery, featured_video, author_type, created_at, updated_at").order("created_at",{ascending:!1});if(a)throw console.error("Authors query error:",a),a;return console.log("Fetched authors:",s?.length??0,"authors"),s??[]}catch(s){throw console.error("Failed to fetch authors:",s),s}},staleTime:0,retry:1}),D=async s=>{if(!s.type.startsWith("image/"))return s;const a=1400,n=.85,p=s.size>12e5,h=await new Promise((W,Q)=>{const L=URL.createObjectURL(s),I=new Image;I.onload=()=>{URL.revokeObjectURL(L),W(I)},I.onerror=()=>{URL.revokeObjectURL(L),Q(new Error("Failed to load image"))},I.src=L}),g=Math.min(1,a/Math.max(h.width,h.height));if(!p&&g===1)return s;const m=document.createElement("canvas");m.width=Math.round(h.width*g),m.height=Math.round(h.height*g);const k=m.getContext("2d");if(!k)return s;k.drawImage(h,0,0,m.width,m.height);const V=await new Promise((W,Q)=>{m.toBlob(L=>L?W(L):Q(new Error("Resize failed")),"image/jpeg",n)}),ee=s.name.replace(/\.[^/.]+$/,".jpg");return new File([V],ee,{type:V.type})},U=async(s,a)=>{const n=await D(s),p=5*1024*1024;if(n.size>p)throw new Error("Profile photo must be 5MB or less.");const h=`author-photos/${a}/${Date.now()}-${n.name}`,{error:g}=await j.storage.from("author-photos").upload(h,n,{upsert:!0,contentType:n.type});if(g)throw g;const{data:m}=j.storage.from("author-photos").getPublicUrl(h);return{path:h,publicUrl:m.publicUrl}},q=G({mutationFn:async s=>{const{values:a,file:n}=s,p={name:a.name,phone:a.phone||null,bio:a.bio||null,photo_url:a.photo_url||null,photo_path:a.photo_path||null,social_links:a.social_links??{},birth_date:a.birth_date||null,residence_city:a.residence_city||null,province:a.province||null,published_works:a.published_works??[],author_gallery:a.author_gallery??[],featured_video:a.featured_video||null,author_type:a.author_type||null},{data:h,error:g}=await j.from("authors").insert(p).select().single();if(g)throw g;if(n&&h?.id){const m=await U(n,h.id),{error:k}=await j.from("authors").update({photo_url:m.publicUrl,photo_path:m.path}).eq("id",h.id);if(k)throw k}},onSuccess:async()=>{console.log("Author created, invalidating queries..."),await o.invalidateQueries({queryKey:["admin","authors"]}),console.log("Refetching authors..."),await o.refetchQueries({queryKey:["admin","authors"]}),console.log("Queries refreshed, closing form"),_(!1),C.success("Author created successfully")},onError:s=>{console.error("Create author error:",s);const a=s.message??"Failed to create author";C.error(a)}}),O=G({mutationFn:async s=>{const{values:a,file:n,id:p}=s;let h=a.photo_path||null,g=a.photo_url||null;if(n){a.photo_path&&await j.storage.from("author-photos").remove([a.photo_path]);const k=await U(n,p);g=k.publicUrl,h=k.path}const{error:m}=await j.from("authors").update({name:a.name,phone:a.phone||null,bio:a.bio||null,photo_url:g,photo_path:h,social_links:a.social_links??{},birth_date:a.birth_date||null,residence_city:a.residence_city||null,province:a.province||null,published_works:a.published_works,author_gallery:a.author_gallery,featured_video:a.featured_video||null,author_type:a.author_type||null}).eq("id",p);if(m)throw m},onSuccess:async()=>{await o.invalidateQueries({queryKey:["admin","authors"]}),await o.refetchQueries({queryKey:["admin","authors"]}),_(!1),P(null),C.success("Author updated successfully")},onError:s=>{console.error("Update author error:",s),C.error(s.message??"Failed to update author")}}),A=G({mutationFn:async s=>{const{data:a}=await j.from("authors").select("photo_path").eq("id",s).single();a?.photo_path&&await j.storage.from("author-photos").remove([a.photo_path]);const{error:n}=await j.from("authors").delete().eq("id",s);if(n)throw n},onSuccess:async()=>{await o.invalidateQueries({queryKey:["admin","authors"]}),await o.refetchQueries({queryKey:["admin","authors"]}),S(null),C.success("Author deleted successfully")},onError:s=>{console.error("Delete author error:",s),C.error(s.message??"Failed to delete author")}}),$=G({mutationFn:async s=>{const{error:a}=await j.from("authors").update({featured:s.featured}).eq("id",s.id);if(a)throw a},onSuccess:()=>{o.invalidateQueries({queryKey:["admin","authors"]}),C.success("Featured status updated")},onError:s=>C.error(s.message??"Failed to update featured status")}),B=async(s,a)=>{c?await O.mutateAsync({values:s,file:a,id:c.id}):await q.mutateAsync({values:s,file:a})},r=s=>{P(s),_(!0)},l=s=>{S(s)};return e.jsx(te,{children:e.jsxs(le,{userRole:t?.role??"admin",userName:i,userEmail:f,onSignOut:E,children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm uppercase text-gray-500",children:"Community"}),e.jsxs("h1",{className:"text-2xl font-semibold text-gray-900",children:["Authors ",w.data?`(${w.data.length})`:""]})]}),e.jsx(v,{onClick:()=>{P(null),_(!0)},children:"Add author"})]}),e.jsx("div",{className:"rounded-2xl border border-gray-200 p-4 bg-white",children:w.isLoading?e.jsx("p",{className:"text-sm text-gray-500",children:"Loading authors…"}):w.isError?e.jsx("p",{className:"text-sm text-rose-600",children:"Failed to load authors. Check connection or permissions."}):w.data?.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:'No authors found. Click "Add author" to create one.'}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500 border-b",children:[e.jsx("th",{className:"py-2 pr-3",children:"Author"}),e.jsx("th",{className:"py-2 pr-3",children:"Phone"}),e.jsx("th",{className:"py-2 pr-3",children:"Tipo de Autor"}),e.jsx("th",{className:"py-2 pr-3",children:"WordPress"}),e.jsx("th",{className:"py-2 pr-3",children:"Featured"}),e.jsx("th",{className:"py-2 pr-3",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y",children:w.data?.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>x(s),children:[e.jsx("td",{className:"py-3 pr-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[s.photo_url?e.jsx("img",{src:s.photo_url,alt:s.name,className:"h-10 w-10 rounded-full object-cover border border-gray-200"}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center",children:e.jsx("span",{className:"text-sm text-gray-600",children:s.name.charAt(0).toUpperCase()})}),e.jsx("div",{children:e.jsx("p",{className:"font-medium text-gray-900",children:s.name})})]})}),e.jsx("td",{className:"py-3 pr-3 text-gray-600",children:s.phone??"—"}),e.jsx("td",{className:"py-3 pr-3 text-gray-600",children:s.author_type??"—"}),e.jsx("td",{className:"py-3 pr-3",children:e.jsx("div",{className:"text-sm text-gray-600",children:s.wp_slug??"—"})}),e.jsx("td",{className:"py-3 pr-3 text-gray-600",children:s.featured?"Yes":"No"}),e.jsx("td",{className:"py-3 pr-3",children:e.jsxs(oe,{children:[e.jsx(ie,{asChild:!0,children:e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:a=>a.stopPropagation(),children:e.jsx(ne,{className:"h-4 w-4"})})}),e.jsxs(ce,{align:"end",children:[e.jsx(de,{children:"Actions"}),e.jsx(M,{onClick:a=>{a.stopPropagation(),x(s)},children:"View details"}),e.jsx(M,{onClick:a=>{a.stopPropagation(),r(s)},children:"Edit"}),e.jsx(K,{}),e.jsx(M,{onClick:a=>{a.stopPropagation(),$.mutate({id:s.id,featured:!(s.featured??!1)})},children:s.featured?"Unfeature":"Mark featured"}),e.jsx(K,{}),e.jsx(M,{onClick:a=>{a.stopPropagation(),l(s.id)},className:"text-red-600",children:"Delete"})]})]})})]},s.id))})]})})})]}),e.jsx(he,{open:y,onOpenChange:_,children:e.jsxs(ue,{className:"overflow-y-auto sm:max-w-lg px-4",children:[e.jsxs(pe,{children:[e.jsx(me,{children:c?"Edit Author":"Add New Author"}),e.jsx(xe,{children:c?"Update author profile information":"Create a new author profile"})]}),e.jsx("div",{className:"mt-6",children:e.jsx(Ce,{initial:c?{name:c.name,phone:c.phone??"",bio:c.bio??"",photo_url:c.photo_url??"",photo_path:c.photo_path??"",social_links:c.social_links??{},birth_date:c.birth_date??"",residence_city:c.residence_city??"",province:c.province??"",published_works:c.published_works??[],author_gallery:c.author_gallery??[],featured_video:c.featured_video??"",author_type:c.author_type??""}:void 0,onSubmit:B,onCancel:()=>{_(!1),P(null)},submitting:q.isPending||O.isPending,mode:c?"edit":"create"})})]})}),e.jsx(z,{open:!!R,onOpenChange:()=>x(null),children:e.jsxs(Y,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(J,{children:[e.jsx(H,{children:"Author Details"}),e.jsx(X,{children:"View author profile information"})]}),R&&e.jsx(Ae,{author:R})]})}),e.jsx(z,{open:!!b,onOpenChange:()=>S(null),children:e.jsxs(Y,{children:[e.jsxs(J,{children:[e.jsx(H,{children:"Delete Author"}),e.jsx(X,{children:"Are you sure you want to delete this author? This action cannot be undone and will remove their profile and all associated data."})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-4",children:[e.jsx(v,{variant:"ghost",onClick:()=>S(null),disabled:A.isPending,children:"Cancel"}),e.jsx(v,{onClick:()=>b&&A.mutate(b),disabled:A.isPending,className:"bg-red-600 hover:bg-red-700",children:A.isPending?"Deleting...":"Delete"})]})]})})]})})}export{Te as component};
