import{r as x,j as e,a as G,B as V,u as z,t as m,s as n}from"./main-B5FlV0ud.js";import{u as _}from"./useMutation-DsfTo1KK.js";import{A as Z,D as $}from"./AdminGuard-CcPwdLTL.js";import{I as g,B as D}from"./button-BmSOyNex.js";import{D as Y,a as J,E as W,b as X,c as ee,d as K,n as A,S as se,j as te,k as re,l as ae,m as ie}from"./sheet-BQfrc174.js";import{T as oe,a as le,b as I,c as y,d as ne,e as f,f as ce}from"./table-BGnGoEK-.js";import{L as d}from"./label-Chk9yu5q.js";import{D as de,a as ue,b as he,c as me,d as xe}from"./dialog-F38b7SJK.js";import"./x-DfPbw0Sj.js";import"./search-BWiiaxVB.js";import"./chevron-right-BD-QEjtD.js";const O={title:"",slug:"",price_mzn:0,stock:0,category:"",language:"pt",is_active:!0,featured:!1,cover_url:"",cover_path:"",description:"",isbn:"",publisher:"",seo_title:"",seo_description:"",author_ids:[]};function ge({initial:b,onSubmit:B,onCancel:L,submitting:E=!1,authors:w,onCreateAuthor:h}){const[o,p]=x.useState({...O,...b,author_ids:b?.author_ids??O.author_ids}),[i,N]=x.useState(b?.cover_url??null),[a,k]=x.useState(null),[P,j]=x.useState(w),[q,T]=x.useState(""),[C,S]=x.useState(!1);x.useEffect(()=>{j(w)},[w]);const l=(t,s)=>{p(r=>({...r,[t]:s}))},Q=t=>{t.preventDefault();const s=o.slug||o.title.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-");B({...o,slug:s},a)},F=async()=>{if(!h)return;const t=q.trim();if(t){S(!0);try{const s=await h(t);j(r=>[...r,s]),l("author_ids",[...o.author_ids,s.id]),T("")}finally{S(!1)}}};return e.jsxs("form",{className:"space-y-4",onSubmit:Q,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"title",children:"Title"}),e.jsx(g,{id:"title",required:!0,value:o.title,onChange:t=>l("title",t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Authors"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Select from the catalog or add a new author."}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[P.map(t=>{const s=o.author_ids.includes(t.id);return e.jsxs("label",{className:"flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:s,onChange:r=>{const c=r.target.checked?[...o.author_ids,t.id]:o.author_ids.filter(v=>v!==t.id);l("author_ids",c)},className:"h-4 w-4 rounded border-gray-300"}),e.jsx("span",{className:"text-gray-900",children:t.name})]},t.id)}),P.length===0&&e.jsx("p",{className:"text-xs text-gray-500",children:"No authors yet."})]}),h&&e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(g,{placeholder:"New author name",value:q,onChange:t=>T(t.target.value),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),F())}}),e.jsx(D,{type:"button",onClick:F,disabled:C,children:C?"Adding…":"Add"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Cover image"}),e.jsx("div",{className:"rounded-xl border border-dashed border-gray-300 bg-gray-50 p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("label",{htmlFor:"cover",className:"inline-flex cursor-pointer items-center gap-2 rounded-full border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-100",children:"Choose file"}),e.jsx("input",{id:"cover",type:"file",accept:"image/*",onChange:t=>{const s=t.target.files?.[0]??null;k(s),s&&N(URL.createObjectURL(s))},className:"hidden"}),e.jsxs("div",{className:"flex flex-col text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:a?.name??i?"Preview loaded":"No file chosen"}),e.jsx("span",{className:"text-xs text-gray-500",children:"JPG/PNG, up to 5MB"})]}),i&&e.jsx("img",{src:i,alt:"Cover preview",className:"h-16 w-12 rounded-md border border-gray-200 object-cover ml-auto"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",value:o.description,onChange:t=>l("description",t.target.value),className:"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",rows:4})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"price",children:"Price (MZN)"}),e.jsx(g,{id:"price",type:"number",min:0,value:o.price_mzn,onChange:t=>l("price_mzn",Number(t.target.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"stock",children:"Stock"}),e.jsx(g,{id:"stock",type:"number",min:0,value:o.stock,onChange:t=>l("stock",Number(t.target.value))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"isbn",children:"ISBN"}),e.jsx(g,{id:"isbn",value:o.isbn,onChange:t=>l("isbn",t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"publisher",children:"Publisher"}),e.jsx(g,{id:"publisher",value:o.publisher,onChange:t=>l("publisher",t.target.value)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"category",children:"Category"}),e.jsx(g,{id:"category",value:o.category,onChange:t=>l("category",t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"language",children:"Language"}),e.jsxs("select",{id:"language",value:o.language,onChange:t=>l("language",t.target.value),className:"w-full rounded-full border border-gray-300 bg-white px-4 py-2 text-sm text-gray-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2",children:[e.jsx("option",{value:"pt",children:"Português"}),e.jsx("option",{value:"en",children:"English"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"seo_title",children:"SEO title"}),e.jsx(g,{id:"seo_title",value:o.seo_title,onChange:t=>l("seo_title",t.target.value)}),e.jsx(d,{htmlFor:"seo_description",className:"pt-1",children:"SEO description"}),e.jsx("textarea",{id:"seo_description",value:o.seo_description,onChange:t=>l("seo_description",t.target.value),className:"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",rows:2})]}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:o.featured,onChange:t=>l("featured",t.target.checked),className:"h-4 w-4 rounded border-gray-300"}),e.jsx("span",{className:"text-gray-900",children:"Featured"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:o.is_active,onChange:t=>l("is_active",t.target.checked),className:"h-4 w-4 rounded border-gray-300"}),e.jsx("span",{className:"text-gray-900",children:"Active"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(D,{type:"button",variant:"ghost",onClick:L,children:"Cancel"}),e.jsx(D,{type:"submit",disabled:E,children:E?"Saving…":"Save"})]})]})}function Se(){const{profile:b,session:B,signOut:L}=G(),E=b?.name??B?.user.email??"Admin",w=B?.user.email??"",h=V(),[o,p]=x.useState(!1),[i,N]=x.useState(null),[a,k]=x.useState(null),P=z({queryKey:["admin","authors","list"],queryFn:async()=>{const{data:s,error:r}=await n.from("authors").select("id, name, photo_path").order("name",{ascending:!0});if(r)throw r;return s},staleTime:6e4}),j=z({queryKey:["admin","books"],queryFn:async()=>{const{data:s,error:r}=await n.from("books").select("id, title, slug, price_mzn, stock, category, language, is_active, featured, cover_url, cover_path, description, description_json, isbn, publisher, seo_title, seo_description, authors:authors_books(author_id, authors(id, name, photo_path))").order("created_at",{ascending:!1});if(r)throw r;return s},staleTime:3e4}),q=_({mutationFn:async s=>{const{error:r}=await n.from("books").update({is_active:s.is_active}).eq("id",s.id);if(r)throw r},onSuccess:()=>{h.invalidateQueries({queryKey:["admin","books"]}),m.success("Status updated")},onError:s=>m.error(s.message??"Failed to update status")}),T=_({mutationFn:async s=>{const{error:r}=await n.from("books").update({featured:s.featured}).eq("id",s.id);if(r)throw r},onSuccess:()=>{h.invalidateQueries({queryKey:["admin","books"]}),m.success("Featured updated")},onError:s=>m.error(s.message??"Failed to update featured")});_({mutationFn:async s=>{const{error:r}=await n.from("books").update({stock:s.stock}).eq("id",s.id);if(r)throw r},onSuccess:()=>{h.invalidateQueries({queryKey:["admin","books"]})}});const C=s=>new Intl.NumberFormat("pt-MZ",{style:"currency",currency:"MZN",maximumFractionDigits:0}).format(s),S=s=>s.cover_url?s.cover_url:s.cover_path?n.storage.from("covers").getPublicUrl(s.cover_path).data.publicUrl:null,l=_({mutationFn:async s=>{const{data:r,error:c}=await n.from("authors").insert({name:s}).select("id, name, photo_path").single();if(c)throw c;return r},onSuccess:()=>{h.invalidateQueries({queryKey:["admin","authors","list"]}),m.success("Author added")},onError:s=>m.error(s.message??"Failed to add author")}),Q=async(s,r)=>{const c=`covers/${r}/${Date.now()}-${s.name}`,{error:v}=await n.storage.from("covers").upload(c,s,{upsert:!0});if(v)throw v;const{data:M}=n.storage.from("covers").getPublicUrl(c);return{path:c,publicUrl:M.publicUrl}},F=_({mutationFn:async s=>{const r=s.author_ids,c=s.id??crypto.randomUUID?.()??Date.now().toString();let v=s.cover_url,M=s.cover_path;if(s.file){const u=await Q(s.file,c);v=u.publicUrl,M=u.path}const R=s.description?{type:"doc",content:[{type:"paragraph",content:[{type:"text",text:s.description}]}]}:null,U={...s,id:s.id??c,cover_url:v,cover_path:M,description_json:R};if(delete U.file,delete U.author_ids,s.id){const{error:u}=await n.from("books").update(U).eq("id",s.id);if(u)throw u}else{const{error:u}=await n.from("books").insert(U);if(u)throw u}if(await n.from("authors_books").delete().eq("book_id",c),r&&r.length>0){const{error:u}=await n.from("authors_books").insert(r.map(H=>({author_id:H,book_id:c})));if(u)throw u}},onSuccess:()=>{h.invalidateQueries({queryKey:["admin","books"]}),p(!1),N(null),m.success("Book saved")},onError:s=>m.error(s.message??"Failed to save book")}),t=_({mutationFn:async s=>{const{error:r}=await n.from("books").delete().eq("id",s);if(r)throw r},onSuccess:()=>{h.invalidateQueries({queryKey:["admin","books"]}),m.success("Book deleted")},onError:s=>m.error(s.message??"Failed to delete book")});return e.jsx(Z,{children:e.jsx($,{userRole:b?.role??"admin",userName:E,userEmail:w,onSignOut:L,children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm uppercase text-gray-500",children:"Catalog"}),e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:"Books"})]}),e.jsx(D,{onClick:()=>{N(null),p(!0)},children:"Add book"})]}),e.jsx("div",{className:"rounded-2xl border border-gray-200 p-4 bg-white",children:j.isLoading?e.jsx("p",{className:"text-sm text-gray-500",children:"Loading books…"}):j.isError?e.jsx("p",{className:"text-sm text-rose-600",children:"Failed to load books. Check connection or permissions."}):e.jsx("div",{className:"space-y-4",children:e.jsxs(oe,{children:[e.jsx(le,{children:e.jsxs(I,{children:[e.jsx(y,{children:"Title"}),e.jsx(y,{children:"Authors"}),e.jsx(y,{children:"Category"}),e.jsx(y,{children:"Language"}),e.jsx(y,{children:"Price"}),e.jsx(y,{children:"Stock"}),e.jsx(y,{children:"Actions"})]})}),e.jsx(ne,{children:j.data?.map(s=>e.jsxs(I,{className:"align-middle cursor-pointer hover:bg-gray-50",onClick:()=>k(s),children:[e.jsx(f,{className:"font-medium text-gray-900",children:s.title}),e.jsx(f,{className:"text-gray-600",children:s.authors?.map(r=>r.authors?.name).filter(Boolean).join(", ")||"—"}),e.jsx(f,{className:"text-gray-600",children:s.category??"—"}),e.jsx(f,{className:"text-gray-600",children:s.language?.toUpperCase()}),e.jsx(f,{className:"text-gray-900",children:C(s.price_mzn)}),e.jsx(f,{className:"text-gray-900",children:s.stock}),e.jsx(f,{className:"text-sm",children:e.jsxs(Y,{children:[e.jsx(J,{asChild:!0,children:e.jsx(D,{variant:"ghost",size:"icon",className:"h-8 w-8",onMouseDown:r=>r.stopPropagation(),onClickCapture:r=>r.stopPropagation(),children:e.jsx(W,{className:"h-4 w-4"})})}),e.jsxs(X,{align:"end",onClick:r=>r.stopPropagation(),children:[e.jsx(ee,{children:"Actions"}),e.jsx(K,{}),e.jsx(A,{onClick:()=>k(s),children:"View details"}),e.jsx(A,{onClick:()=>{N(s),p(!0)},children:"Edit"}),e.jsx(A,{onClick:()=>T.mutate({id:s.id,featured:!s.featured}),children:s.featured?"Unfeature":"Mark featured"}),e.jsx(A,{onClick:()=>q.mutate({id:s.id,is_active:!s.is_active}),children:s.is_active?"Deactivate":"Activate"}),e.jsx(K,{}),e.jsx(A,{className:"text-destructive focus:text-destructive",onClick:()=>t.mutate(s.id),children:"Delete"})]})]})})]},s.id))}),j.data?.length===0&&e.jsx(ce,{children:"No books yet."})]})})}),e.jsx(se,{open:o,onOpenChange:p,children:e.jsxs(te,{className:"w-full sm:max-w-xl px-4 overflow-hidden",children:[e.jsxs(re,{children:[e.jsx(ae,{children:i?"Edit book":"Add book"}),e.jsx(ie,{children:"Manage title, slug, pricing, stock, and visibility."})]}),e.jsx("div",{className:"pt-4 max-h-[80vh] overflow-y-auto pr-2 space-y-4",children:e.jsx(ge,{initial:i?{title:i.title,slug:i.slug,price_mzn:i.price_mzn,stock:i.stock,category:i.category??"",language:i.language,is_active:i.is_active,featured:i.featured??!1,cover_url:i.cover_url??"",cover_path:i.cover_path??"",description:i.description??"",isbn:i.isbn??"",publisher:i.publisher??"",seo_title:i.seo_title??"",seo_description:i.seo_description??"",author_ids:i.authors?.map(s=>s.author_id)??[]}:void 0,submitting:F.isPending,onSubmit:async(s,r)=>{await F.mutateAsync({...s,id:i?.id,file:r})},authors:P.data?.map(s=>({id:s.id,name:s.name??"Autor"}))??[],onCreateAuthor:s=>l.mutateAsync(s),onCancel:()=>{p(!1),N(null)}})})]})}),e.jsx(de,{open:!!a,onOpenChange:()=>k(null),children:e.jsxs(ue,{className:"sm:max-w-xl",children:[e.jsxs(he,{children:[e.jsx(me,{children:a?.title??"Book detail"}),e.jsx(xe,{children:a?.seo_description??a?.description??"Book details"})]}),a&&e.jsxs("div",{className:"space-y-4",children:[S(a)&&e.jsx("img",{src:S(a)??"",alt:a.title,className:"w-full max-h-64 rounded-xl object-cover border border-gray-200"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Price"}),e.jsx("p",{className:"font-semibold text-gray-900",children:C(a.price_mzn)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Stock"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.stock})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Category"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.category??"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Language"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.language?.toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"ISBN"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.isbn??"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Publisher"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.publisher??"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Featured"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.featured?"Yes":"No"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Active"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.is_active?"Yes":"No"})]})]}),a.authors&&a.authors.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-gray-500 text-sm",children:"Authors"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.authors.map(s=>s.authors?.name).filter(Boolean).join(", ")})]}),a.description&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-gray-500 text-sm",children:"Description"}),e.jsx("p",{className:"text-gray-900 whitespace-pre-line",children:a.description})]}),(a.seo_title||a.seo_description)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-gray-500 text-sm",children:"SEO"}),e.jsx("p",{className:"text-gray-900 font-semibold",children:a.seo_title}),e.jsx("p",{className:"text-gray-700 text-sm",children:a.seo_description})]})]})]})})]})})})}export{Se as component};
