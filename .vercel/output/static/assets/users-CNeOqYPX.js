import{a as z,B as Y,r as m,u as A,t as u,s as i,j as s}from"./main-B5FlV0ud.js";import{u as R}from"./useMutation-DsfTo1KK.js";import{A as J,D as W}from"./AdminGuard-CcPwdLTL.js";import{B as g,I as j}from"./button-BmSOyNex.js";import{D as X,a as Z,E as ee,b as se,c as ae,d as re,e as U,f as Q,g as P,h as k,i as K,S as te,j as ne,k as le,l as ie,m as oe}from"./sheet-BQfrc174.js";import{T as de,a as ce,b as L,c as o,d as me,e as d,f as ue}from"./table-BGnGoEK-.js";import{S as B}from"./StatusBadge-wyWTkgTV.js";import{S as he}from"./search-BWiiaxVB.js";import"./x-DfPbw0Sj.js";import"./chevron-right-BD-QEjtD.js";const C={name:"",email:"",password:"",role:"author",status:"pending"};function Se(){const{profile:S,session:q,signOut:V}=z(),I=S?.name??q?.user.email??"Admin",H=q?.user.email??"",h=Y(),[O,x]=m.useState(!1),[n,l]=m.useState(C),[r,f]=m.useState({search:"",role:"all",status:"all"}),p=A({queryKey:["admin","users",r],queryFn:async()=>{let e=i.from("profiles").select("id, name, email, role, status, created_at").order("created_at",{ascending:!1});r.role!=="all"&&(e=e.eq("role",r.role)),r.status!=="all"&&(e=e.eq("status",r.status)),r.search&&(e=e.or(`name.ilike.%${r.search}%,email.ilike.%${r.search}%`));const{data:a,error:t}=await e;if(t)throw t;return a??[]},staleTime:3e4}),D=A({queryKey:["admin","users","admin-count"],queryFn:async()=>{const{count:e,error:a}=await i.from("profiles").select("id",{count:"exact",head:!0}).eq("role","admin");if(a)throw a;return e??0},staleTime:3e4}).data??0,y=R({mutationFn:async e=>{const a=e.email.toLowerCase().trim();if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))throw new Error("Please enter a valid email address");if(e.password.length<8)throw new Error("Password must be at least 8 characters");const{data:T,error:F}=await i.auth.signUp({email:a,password:e.password,options:{data:{name:e.name},emailRedirectTo:void 0}});if(F)throw F;if(!T.user)throw new Error("Failed to create user");const v=T.user.id,N=e.role,M=N==="author"?e.status??"pending":null,{data:G}=await i.from("profiles").select("id").eq("id",v).maybeSingle();if(G){const{error:c}=await i.from("profiles").update({name:e.name,email:a,role:N,status:M}).eq("id",v);if(c)throw c}else{const{error:c}=await i.from("profiles").insert({id:v,name:e.name,email:a,role:N,status:M});if(c)throw c}},onSuccess:()=>{h.invalidateQueries({queryKey:["admin","users"]}),h.invalidateQueries({queryKey:["admin","users","admin-count"]}),x(!1),l(C),u.success("User created")},onError:e=>u.error(e.message??"Failed to create user")}),E=R({mutationFn:async e=>{const{error:a}=await i.from("profiles").update({role:e.role,status:e.status}).eq("id",e.id);if(a)throw a},onSuccess:()=>{h.invalidateQueries({queryKey:["admin","users"]}),h.invalidateQueries({queryKey:["admin","users","admin-count"]}),u.success("User updated")},onError:e=>u.error(e.message??"Failed to update user")}),w=m.useMemo(()=>["admin","author","customer"],[]),b=m.useMemo(()=>["pending","approved","rejected"],[]),_=(e,a)=>{if(e.role==="admin"&&a!=="admin"&&D<=1){u.error("You cannot remove the last admin");return}const t=a==="author"?e.status??"pending":null;E.mutate({id:e.id,role:a,status:t})},$=(e,a)=>{e.role==="author"&&E.mutate({id:e.id,role:e.role,status:a})};return s.jsx(J,{children:s.jsxs(W,{userRole:S?.role??"admin",userName:I,userEmail:H,onSignOut:V,children:[s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm uppercase text-gray-500",children:"Community"}),s.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:"Users"})]}),s.jsx(g,{onClick:()=>{l(C),x(!0)},children:"Add user"})]}),s.jsx("div",{className:"rounded-2xl border border-gray-200 p-4 bg-white",children:s.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[s.jsxs("div",{className:"relative flex-1 min-w-[220px]",children:[s.jsx(he,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),s.jsx(j,{placeholder:"Search users...",value:r.search,onChange:e=>f(a=>({...a,search:e.target.value})),className:"pl-9"})]}),s.jsxs("select",{value:r.role,onChange:e=>f(a=>({...a,role:e.target.value})),className:"w-full sm:w-44 rounded-full border border-gray-300 bg-white px-4 py-2 text-sm text-gray-900",children:[s.jsx("option",{value:"all",children:"All Roles"}),w.map(e=>s.jsx("option",{value:e,children:e},e))]}),s.jsxs("select",{value:r.status,onChange:e=>f(a=>({...a,status:e.target.value})),className:"w-full sm:w-44 rounded-full border border-gray-300 bg-white px-4 py-2 text-sm text-gray-900",children:[s.jsx("option",{value:"all",children:"All Status"}),b.map(e=>s.jsx("option",{value:e,children:e},e))]})]})}),s.jsx("div",{className:"rounded-2xl border border-gray-200 bg-white overflow-hidden",children:p.isLoading?s.jsx("p",{className:"text-sm text-gray-500 p-4",children:"Loading users..."}):p.isError?s.jsx("p",{className:"text-sm text-rose-600 p-4",children:"Failed to load users. Check connection or permissions."}):s.jsxs(de,{children:[s.jsx(ce,{children:s.jsxs(L,{children:[s.jsx(o,{children:"Name"}),s.jsx(o,{children:"Email"}),s.jsx(o,{children:"Role"}),s.jsx(o,{children:"Status"}),s.jsx(o,{children:"Date"}),s.jsx(o,{className:"text-right",children:"Actions"})]})}),s.jsx(me,{children:p.data?.map(e=>s.jsxs(L,{children:[s.jsx(d,{className:"font-medium text-gray-900",children:e.name}),s.jsx(d,{className:"text-gray-600",children:e.email??"—"}),s.jsx(d,{children:s.jsx(B,{label:e.role??"customer",variant:e.role==="admin"?"info":e.role==="author"?"warning":"muted"})}),s.jsx(d,{children:e.role==="author"?s.jsx(B,{label:e.status??"pending",variant:e.status==="approved"?"success":e.status==="rejected"?"danger":"warning"}):s.jsx("span",{className:"text-sm text-gray-500",children:"—"})}),s.jsx(d,{className:"text-gray-600 text-sm",children:new Date(e.created_at).toLocaleDateString()}),s.jsx(d,{className:"text-right",children:s.jsxs(X,{children:[s.jsx(Z,{asChild:!0,children:s.jsx(g,{variant:"ghost",size:"icon",className:"h-8 w-8",children:s.jsx(ee,{className:"h-4 w-4"})})}),s.jsxs(se,{align:"end",className:"w-48",children:[s.jsx(ae,{children:"Actions"}),s.jsx(re,{}),s.jsxs(U,{children:[s.jsx(Q,{children:"Set role"}),s.jsx(P,{children:s.jsx(k,{value:e.role??"customer",onValueChange:a=>_(e,a),children:w.map(a=>s.jsx(K,{value:a,disabled:e.role==="admin"&&D<=1&&a!=="admin",children:a},a))})})]}),s.jsxs(U,{children:[s.jsx(Q,{disabled:e.role!=="author",children:"Set status"}),s.jsx(P,{children:s.jsx(k,{value:e.status??"pending",onValueChange:a=>$(e,a),children:b.map(a=>s.jsx(K,{value:a,children:a},a))})})]})]})]})})]},e.id))}),p.data?.length===0&&s.jsx(ue,{children:"No users found."})]})})]}),s.jsx(te,{open:O,onOpenChange:x,children:s.jsxs(ne,{className:"w-full sm:max-w-lg px-4",children:[s.jsxs(le,{children:[s.jsx(ie,{children:"New User"}),s.jsx(oe,{children:"Create an admin, author, or customer account."})]}),s.jsxs("form",{className:"space-y-4 pt-4",onSubmit:e=>{e.preventDefault(),y.mutate(n)},children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Name"}),s.jsx(j,{required:!0,value:n.name,onChange:e=>l(a=>({...a,name:e.target.value})),placeholder:"Full name"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Email"}),s.jsx(j,{type:"email",required:!0,value:n.email,onChange:e=>l(a=>({...a,email:e.target.value})),placeholder:"name@example.com"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Password"}),s.jsx(j,{type:"password",required:!0,value:n.password,onChange:e=>l(a=>({...a,password:e.target.value})),placeholder:"At least 8 characters"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Role"}),s.jsx("select",{value:n.role,onChange:e=>{const a=e.target.value;l(t=>({...t,role:a,status:a==="author"?t.status??"pending":null}))},className:"w-full rounded-full border border-gray-300 bg-white px-4 py-2 text-sm text-gray-900",children:w.map(e=>s.jsx("option",{value:e,children:e},e))})]}),n.role==="author"&&s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Status"}),s.jsx("select",{value:n.status??"pending",onChange:e=>l(a=>({...a,status:e.target.value})),className:"w-full rounded-full border border-gray-300 bg-white px-4 py-2 text-sm text-gray-900",children:b.map(e=>s.jsx("option",{value:e,children:e},e))})]}),s.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[s.jsx(g,{type:"button",variant:"ghost",onClick:()=>x(!1),children:"Cancel"}),s.jsx(g,{type:"submit",disabled:y.isPending,children:y.isPending?"Creating...":"Create User"})]})]})]})})]})})}export{Se as component};
